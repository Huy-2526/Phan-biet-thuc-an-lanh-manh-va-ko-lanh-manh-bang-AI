<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Health Scanner v4.5 - Accuracy Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

    <style>
        /* GIỮ NGUYÊN CSS CỦA HUY */
        :root { --navy: #0c2461; --green: #00ff00; --red: #ff3b30; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: #f0f2f5; }
        header { background: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--navy); }
        .brand { font-weight: 800; color: var(--navy); }
        .main-content { display: flex; flex-direction: column; max-width: 1200px; margin: 10px auto; padding: 0 10px; gap: 15px; }
        @media (min-width: 768px) { .main-content { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 20px; padding: 20px; } }
        .camera-container { background: #000; border-radius: 15px; position: relative; aspect-ratio: 4/3; overflow: hidden; border: 3px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .status-header { background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; font-weight: 800; color: var(--navy); border-left: 4px solid var(--navy); margin-bottom: 12px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; background: var(--navy); color: white; margin-bottom: 10px; font-size: 1rem; }
        .btn-scan { background: #238636 !important; border: 2px solid #00ff00 !important; animation: blink 1.5s infinite; }
        @keyframes blink {
            0% { box-shadow: 0 0 5px #1e90ff; }
            50% { box-shadow: 0 0 20px #00ff00; transform: scale(1.01); }
            100% { box-shadow: 0 0 5px #1e90ff; }
        }
        #res-box { text-align: center; padding: 25px 10px; border-radius: 8px; background: #f8f9fa; border: 2px dashed #ddd; transition: 0.4s; }
        #res-text { font-size: 1.8rem; font-weight: 900; display: block; margin-bottom: 8px; }
        #res-sub { font-size: 0.95rem; font-weight: 600; color: #666; }
        .healthy-bg { background: #e8f5e9 !important; border-color: #2e7d32 !important; }
        .unhealthy-bg { background: #ffebee !important; border-color: #c62828 !important; }
        .healthy-text { color: #2e7d32; }
        .unhealthy-text { color: #c62828; }
    </style>
</head>
<body>

<header>
    <div class="brand">AI HEALTH SCANNER v4.5</div>
    <div id="clock">00:00:00</div>
</header>

<div class="main-content">
    <div class="camera-container">
        <video id="video" autoplay muted playsinline></video>
    </div>

    <div class="control-panel">
        <div class="card">
            <div id="status" class="status-header">Hệ thống đang sẵn sàng...</div>
            <button class="btn btn-scan" onclick="enhancedScan()">BẤM ĐỂ QUÉT BẠN ƠI!</button>
            <button class="btn" style="background:#555" onclick="location.reload()">LÀM MỚI</button>
        </div>

        <div class="card">
            <div id="res-box">
                <span id="res-text">ĐANG ĐỢI...</span>
                <span id="res-sub">Hãy đưa thực phẩm lại gần camera</span>
            </div>
        </div>
    </div>
</div>

<script>
    let model;
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const resBox = document.getElementById('res-box');
    const resText = document.getElementById('res-text');
    const resSub = document.getElementById('res-sub');

    // Khởi tạo camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(s => video.srcObject = s);

    // Tải AI
    async function initAI() {
        try {
            model = await mobilenet.load({version: 2, alpha: 1.0}); // Dùng bản nặng hơn xíu nhưng chuẩn hơn
            status.innerText = "AI ĐÃ ONLINE!";
        } catch (e) {
            status.innerText = "LỖI TẢI AI!";
        }
    }

    // Hàm quét nâng cao
    async function enhancedScan() {
        if (!model) return;
        
        status.innerText = "ĐANG SOI KỸ... (0/5)";
        let allResults = "";
        
        // Quét 5 lần liên tục để lấy mẫu chung
        for(let i = 1; i <= 5; i++) {
            status.innerText = `ĐANG SOI KỸ... (${i}/5)`;
            const predictions = await model.classify(video);
            
            // Chỉ lấy những kết quả có độ tin cậy trên 15%
            const filtered = predictions
                .filter(p => p.probability > 0.15)
                .map(p => p.className.toLowerCase())
                .join(" ");
            
            allResults += filtered + " ";
            await new Promise(r => setTimeout(r, 100)); // Nghỉ 0.1s giữa các lần quét
        }

        console.log("Dữ liệu tổng hợp:", allResults);

        const badKeywords = [
            "pizza", "burger", "fries", "chips", "hotdog", "fried", "dough", "bread", "noodle", "ramen",
            "candy", "chocolate", "sweet", "sugar", "donut", "cookie", "cake", "ice cream",
            "bottle", "wine", "beer", "can", "pop", "soda", "cola", "coke", "espresso", "sauce",
            "package", "packet", "carton", "box", "plastic", "wrapper", "container", "beaker", "vial",
            "snack", "pretzel", "cheeseburger", "milkshake", "carbonated"
        ];

        const isUnhealthy = badKeywords.some(word => allResults.includes(word));

        if (isUnhealthy) {
            resText.innerText = "❌ HẠN CHẾ ĂN/UỐNG";
            resText.className = "unhealthy-text";
            resSub.innerText = "Phát hiện thành phần không tốt cho sức khỏe!";
            resBox.className = "unhealthy-bg";
            status.style.borderLeftColor = "var(--red)";
        } else {
            resText.innerText = "✅ ĂN/UỐNG ĐƯỢC";
            resText.className = "healthy-text";
            resSub.innerText = "Sản phẩm có vẻ an toàn. Thưởng thức thôi!";
            resBox.className = "healthy-bg";
            status.style.borderLeftColor = "var(--green)";
        }
        
        status.innerText = "QUÉT HOÀN TẤT!";
    }

    setInterval(() => { 
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('vi-VN'); 
    }, 1000);

    initAI();
</script>
</body>
</html>

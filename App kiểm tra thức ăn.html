<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Detector (Final Web App)</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    
    <style>
        body { 
            font-family: sans-serif; 
            text-align: center; 
            margin-top: 20px; 
            background-color: #f4f4f9; 
        }
        /* Container cho webcam */
        #webcam-container {
            margin: 0 auto;
            display: inline-block;
            border: 4px solid #333;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #label {
            font-size: 28px;
            margin-top: 20px;
            color: #28a745; 
            font-weight: bold;
        }
    </style>
</head>
<body>
    
    <h1>Camera Nhận Diện Món Ăn</h1>
    <div id="webcam-container"></div>
    <div id="label">Đang tải và kiểm tra camera...</div>

<script>
    // Đường dẫn tới model. Giả định model.json và metadata.json nằm cùng thư mục
    const URL = "./";

    let model, webcam, maxPredictions;

    async function init() {
        try {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            // 1. Tải model
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // 2. Thiết lập webcam
            const flip = true; 
            webcam = new tmImage.Webcam(700, 450, flip); 
            await webcam.setup(); // Yêu cầu quyền truy cập camera
            await webcam.play();
            
            // Bắt đầu vòng lặp dự đoán
            window.requestAnimationFrame(loop);

            // 3. Gắn canvas của webcam vào container
            document.getElementById("webcam-container").appendChild(webcam.canvas);
            
            document.getElementById("label").innerText = "Đã sẵn sàng! Đưa món ăn vào trước camera...";
        } catch (error) {
            // Thêm xử lý lỗi nếu model/camera thất bại
            console.error("Lỗi khởi tạo:", error);
            document.getElementById("label").innerHTML = 
                `LỖI KHỞI TẠO: ${error.message} <br> 
                 <small>Kiểm tra quyền truy cập camera hoặc đường dẫn model (cần Live Server/Hosting).</small>`;
        }
    }

    async function loop() {
        webcam.update(); // Cập nhật khung hình
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        
        // Tìm kết quả có xác suất cao nhất
        let best = prediction[0];
        for (let i = 1; i < prediction.length; i++) {
            if (prediction[i].probability > best.probability) {
                best = prediction[i];
            }
        }

        // Hiển thị kết quả
        const probabilityPercent = (best.probability * 100).toFixed(1);
        document.getElementById("label").innerHTML = 
            `${best.className} (${probabilityPercent}%)`;
    }

    init();
</script>
</body>
</html>